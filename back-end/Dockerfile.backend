FROM python:3.9-slim-buster

RUN apt-get update && apt-get install -y \
  gcc \
  python3-dev \
  libpq-dev \
  build-essential \
  libsqlite3-dev \
  zlib1g-dev \
  git \
  && rm -rf /var/lib/apt/lists/*

# Clone and install Tippecanoe
WORKDIR /tippecanoe
RUN git clone https://github.com/mapbox/tippecanoe.git && \
    cd tippecanoe && \
    make -j && \
    make install

# Check if Tippecanoe is in PATH
RUN which tippecanoe || { echo 'Tippecanoe not found in PATH'; exit 1; }

WORKDIR /app

COPY requirements.txt requirements.txt
RUN pip3 install -r requirements.txt

COPY . .

# Copy the entrypoint script and wait-for script, and make them executable
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

RUN mkdir -p /app/alembic/versions

# Use the wait-for script in your entrypoint
ENTRYPOINT ["/entrypoint.sh"]
